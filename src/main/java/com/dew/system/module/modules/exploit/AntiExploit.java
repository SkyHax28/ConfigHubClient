package com.dew.system.module.modules.exploit;

import com.dew.system.event.events.ReceivedPacketEvent;
import com.dew.system.module.Module;
import com.dew.system.module.ModuleCategory;
import com.dew.utils.LogUtil;
import net.minecraft.network.Packet;
import net.minecraft.network.play.server.*;
import org.lwjgl.input.Keyboard;

public class AntiExploit extends Module {

    public AntiExploit() {
        super("Anti Exploit", ModuleCategory.EXPLOIT, Keyboard.KEY_NONE, true, true, true);
    }

    @Override
    public void onReceivedPacket(ReceivedPacketEvent event) {
        Packet<?> packet = event.packet;

        if (packet instanceof S2BPacketChangeGameState && ((S2BPacketChangeGameState) packet).getGameState() == 5 && !mc.isDemo()) {
            event.cancel();
            LogUtil.printChat("Blocked a demo crash packet");
        }

        if (packet instanceof S27PacketExplosion) {
            if (((S27PacketExplosion) packet).getX() > 1E9 || ((S27PacketExplosion) packet).getY() > 1E9 || ((S27PacketExplosion) packet).getZ() > 1E9 || ((S27PacketExplosion) packet).getStrength() == Integer.MAX_VALUE) {
                event.cancel();
                LogUtil.printChat("The server tried to crash your client with explosion");
            }
        }

        if (packet instanceof S2APacketParticles) {
            if (((S2APacketParticles) packet).getXCoordinate() > 1E9 || ((S2APacketParticles) packet).getYCoordinate() > 1E9 || ((S2APacketParticles) packet).getZCoordinate() > 1E9 || ((S2APacketParticles) packet).getParticleSpeed() > 1E9 || ((S2APacketParticles) packet).getXOffset() > 1E9 || ((S2APacketParticles) packet).getYOffset() > 1E9 || ((S2APacketParticles) packet).getZOffset() > 1E9) {
                event.cancel();
                LogUtil.printChat("The server tried to crash your client with particles");
            }
        }

        if (packet instanceof S0EPacketSpawnObject) {
            if (Math.abs(((S0EPacketSpawnObject) packet).getYaw()) > 1E4 || Math.abs(((S0EPacketSpawnObject) packet).getPitch()) > 1E4) {
                event.cancel();
                LogUtil.printChat("Blocked bogus spawn packet (yaw/pitch overflow)");
            }
        }

        if (packet instanceof S3FPacketCustomPayload) {
            String channel = ((S3FPacketCustomPayload) packet).getChannelName();
            if (((S3FPacketCustomPayload) packet).getBufferData() == null || ((S3FPacketCustomPayload) packet).getBufferData().array().length > 1024 * 50) {
                event.cancel();
                LogUtil.printChat("Blocked custom payload packet from channel: " + channel);
            }
        }

        if (packet instanceof S09PacketHeldItemChange) {
            if (((S09PacketHeldItemChange) packet).getHeldItemHotbarIndex() == Integer.MAX_VALUE) {
                event.cancel();
                LogUtil.printChat("The server tried to crash your client with hotbar switch");
            }
        }
    }
}
