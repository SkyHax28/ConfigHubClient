package com.dew.system.module.modules.exploit;

import com.dew.system.event.events.PreMotionEvent;
import com.dew.system.event.events.SendPacketEvent;
import com.dew.system.event.events.TickEvent;
import com.dew.system.module.Module;
import com.dew.system.module.ModuleCategory;
import com.dew.system.settingsvalue.MultiSelectionValue;
import com.dew.utils.LogUtil;
import com.dew.utils.PacketUtil;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.*;
import org.lwjgl.input.Keyboard;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

public class PacketBlaster extends Module {

    private static final MultiSelectionValue mode = new MultiSelectionValue(
            "Mode",
            Arrays.asList(
                    "Blink Jump", "Invalid Sprint Combo"
            ),
            "Blink Jump", "Invalid Sprint Combo", "KeepAlive Flood", "Transaction Cancel",
            "Position Explode", "C0F Spoof", "OpenWindow Spam", "Yaw-Pitch Lock",
            "Silent Swing", "Item Swap Spam", "CreativeDrop Spam"
    );
    private final List<Packet<?>> blinkBuffer = new ArrayList<>();
    private int ticks;
    public PacketBlaster() {
        super("Packet Blaster", ModuleCategory.EXPLOIT, Keyboard.KEY_NONE, false, true, true);
    }

    @Override
    public void onEnable() {
        blinkBuffer.clear();
        ticks = 0;
        LogUtil.printChat("§a[PacketBlaster] Enabled with modes: " + String.join(", ", mode.get()));
    }

    @Override
    public void onDisable() {
        LogUtil.printChat("§c[PacketBlaster] Disabling. Sending " + blinkBuffer.size() + " blinked packets...");
        for (Packet<?> packet : blinkBuffer) {
            PacketUtil.sendPacketAsSilent(packet);
        }
        blinkBuffer.clear();
    }

    @Override
    public void onTick(TickEvent event) {
        if (mc.thePlayer == null) return;

        ticks++;

        if (mode.isSelected("KeepAlive Flood") && ticks % 5 == 0) {
            LogUtil.printChat("§b[PacketBlaster] Sending KeepAlive flood burst...");
            for (int i = 0; i < 20; i++) {
                PacketUtil.sendPacket(new C00PacketKeepAlive((int) (Math.random() * Integer.MAX_VALUE)));
            }
        }

        if (mode.isSelected("Transaction Cancel") && ticks % 10 == 0) {
            LogUtil.printChat("§b[PacketBlaster] Sending fake Transaction cancels...");
            for (short i = 0; i < 5; i++) {
                PacketUtil.sendPacket(new C0FPacketConfirmTransaction(0, i, false));
            }
        }

        if (mode.isSelected("OpenWindow Spam") && mc.currentScreen == null) {
            LogUtil.printChat("§b[PacketBlaster] Sending OpenWindow spam...");
            for (int i = 0; i < 3; i++) {
                PacketUtil.sendPacket(new C16PacketClientStatus(C16PacketClientStatus.EnumState.OPEN_INVENTORY_ACHIEVEMENT));
            }
        }

        if (mode.isSelected("Item Swap Spam")) {
            LogUtil.printChat("§b[PacketBlaster] Spamming item slot swaps...");
            for (int i = 0; i < 3; i++) {
                PacketUtil.sendPacket(new C09PacketHeldItemChange(mc.thePlayer.inventory.currentItem));
            }
        }
    }

    @Override
    public void onPreMotion(PreMotionEvent event) {
        if (mode.isSelected("Yaw-Pitch Lock")) {
            event.yaw = 0f;
            event.pitch = 0f;
            LogUtil.printChat("§b[PacketBlaster] Yaw-Pitch locked to 0, 0");
        }

        if (mode.isSelected("Position Explode")) {
            LogUtil.printChat("§b[PacketBlaster] Sending PositionExplode spoof...");
            PacketUtil.sendPacket(new C03PacketPlayer.C04PacketPlayerPosition(
                    mc.thePlayer.posX, mc.thePlayer.posY + 999, mc.thePlayer.posZ, true));
        }

        if (mode.isSelected("Silent Swing")) {
            LogUtil.printChat("§b[PacketBlaster] Performing silent swing...");
            mc.thePlayer.swingItem();
            PacketUtil.sendPacket(new C0APacketAnimation());
        }
    }

    @Override
    public void onSendPacket(SendPacketEvent event) {
        Packet<?> packet = event.packet;

        if (mode.isSelected("Blink Jump") && packet instanceof C03PacketPlayer) {
            blinkBuffer.add(packet);
            event.cancel();
            LogUtil.printChat("§b[PacketBlaster] Blink: Stored C03PacketPlayer (buffer size: " + blinkBuffer.size() + ")");
        }

        if (mode.isSelected("Invalid Sprint Combo") && packet instanceof C0BPacketEntityAction) {
            C0BPacketEntityAction.Action action = ((C0BPacketEntityAction) packet).getAction();
            if (action == C0BPacketEntityAction.Action.START_SPRINTING) {
                LogUtil.printChat("§b[PacketBlaster] Sending Invalid Sprint Combo");
                PacketUtil.sendPacketAsSilent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SPRINTING));
                PacketUtil.sendPacketAsSilent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SNEAKING));
            }
        }

        if (mode.isSelected("C0F Spoof") && packet instanceof C0FPacketConfirmTransaction) {
            event.cancel();
            LogUtil.printChat("§b[PacketBlaster] Canceled ConfirmTransaction");
        }

        if (mode.isSelected("CreativeDrop Spam") && mc.thePlayer.capabilities.isCreativeMode && ticks % 2 == 0) {
            LogUtil.printChat("§b[PacketBlaster] Sending Creative drop spam...");
            for (int i = 0; i < 5; i++) {
                PacketUtil.sendPacket(new C10PacketCreativeInventoryAction(36 + i, mc.thePlayer.getHeldItem()));
            }
        }
    }
}