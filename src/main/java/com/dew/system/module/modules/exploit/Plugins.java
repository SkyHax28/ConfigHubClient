package com.dew.system.module.modules.exploit;

import com.dew.system.event.events.PreMotionEvent;
import com.dew.system.event.events.ReceivedPacketEvent;
import com.dew.system.event.events.LoadWorldEvent;
import com.dew.system.module.Module;
import com.dew.system.module.ModuleCategory;
import com.dew.utils.Clock;
import com.dew.utils.LogUtil;
import com.dew.utils.PacketUtil;
import net.minecraft.network.play.client.C14PacketTabComplete;
import net.minecraft.network.play.server.S3APacketTabComplete;
import org.lwjgl.input.Keyboard;

import java.util.LinkedHashSet;
import java.util.Set;

public class Plugins extends Module {

    private final Set<String> cachedPlugins = new LinkedHashSet<>();
    private final Clock clock = new Clock();
    private int step = 0;
    private boolean finished = false;
    private long lastStepTime = 0L;
    public Plugins() {
        super("Plugins", ModuleCategory.EXPLOIT, Keyboard.KEY_NONE, false, false, true);
    }

    public long getClockMs() {
        return clock.getReachedTime();
    }

    private void resetStates() {
        cachedPlugins.clear();
        clock.reset();
        step = 0;
        finished = false;
        lastStepTime = 0L;
    }

    @Override
    public void onEnable() {
        resetStates();
        sendNextRequest();
        lastStepTime = System.currentTimeMillis();
    }

    @Override
    public void onDisable() {
        resetStates();
    }

    @Override
    public void onLoadWorld(LoadWorldEvent event) {
        this.setState(false);
    }

    @Override
    public void onPreMotion(PreMotionEvent event) {
        if (!finished && System.currentTimeMillis() - lastStepTime > 500) {
            step++;
            sendNextRequest();
            lastStepTime = System.currentTimeMillis();
        }

        if (!finished && clock.hasTimePassed(7000L)) {
            LogUtil.printChat("§c§lFailed to detect plugins");
            this.setState(false);
            finished = true;
        }
    }

    @Override
    public void onReceivedPacket(ReceivedPacketEvent event) {
        if (!(event.packet instanceof S3APacketTabComplete)) return;

        String[] commands = ((S3APacketTabComplete) event.packet).func_149630_c();
        for (String command : commands) {
            String[] parts = command.split(":");
            if (parts.length > 1 && !parts[0].startsWith("/minecraft")) {
                String pluginName = parts[0].replace("/", "");
                cachedPlugins.add(pluginName);
            }
        }

        if (step >= 3) finishDetection();
    }

    private void sendNextRequest() {
        if (finished) return;

        switch (step) {
            case 0:
                PacketUtil.sendPacket(new C14PacketTabComplete("/version "));
                break;
            case 1:
                PacketUtil.sendPacket(new C14PacketTabComplete("/bukkit:version "));
                break;
            case 2:
                PacketUtil.sendPacket(new C14PacketTabComplete("/"));
                break;
            default:
                finishDetection();
                break;
        }
    }

    private void finishDetection() {
        if (finished) return;
        finished = true;

        if (cachedPlugins.isEmpty()) {
            LogUtil.printChat("§6§lNo plugins found");
        } else {
            String joined = String.join("§7, §a", cachedPlugins);
            LogUtil.printChat("§6§lPlugins §7(§b" + cachedPlugins.size() + "§7) §oTook " + clock.getReachedTime() + "ms");
            LogUtil.printChat("§a" + joined);
        }

        this.setState(false);
    }
}
