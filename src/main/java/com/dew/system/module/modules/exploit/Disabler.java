package com.dew.system.module.modules.exploit;

import com.dew.DewCommon;
import com.dew.system.event.events.*;
import com.dew.system.module.Module;
import com.dew.system.module.ModuleCategory;
import com.dew.system.module.modules.player.InvManager;
import com.dew.system.settingsvalue.MultiSelectionValue;
import com.dew.utils.LogUtil;
import com.dew.utils.MovementUtil;
import com.dew.utils.PacketUtil;
import net.minecraft.client.gui.inventory.GuiInventory;
import net.minecraft.init.Items;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.*;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;
import net.minecraft.potion.Potion;
import org.lwjgl.input.Keyboard;

import java.util.Arrays;

public class Disabler extends Module {

    public Disabler() {
        super("Disabler", ModuleCategory.EXPLOIT, Keyboard.KEY_NONE, false, true, true);
    }

    private static final MultiSelectionValue mode = new MultiSelectionValue("Mode", Arrays.asList("No Sprint"), "No Sprint", "Hypixel Motion", "Hypixel InvMove", "Hypixel Omni Sprint", "Verus", "Test");

    private boolean watchDogDisabled = false;
    private boolean startDisabler = false;
    private boolean stuckOnAir = false;
    private int airStuckTicks = 0;
    private int airTicks = 0;

    private boolean sentFirstOpen = false;
    private boolean caughtClientStatus = false;
    private boolean caughtCloseWindow = false;

    public boolean canLowHop() {
        return this.isEnabled() && mode.isSelected("Hypixel Motion") && !startDisabler && watchDogDisabled;
    }

    private int verusTicks = 0;

    @Override
    public void onEnable() {
        this.resetState(mode.isSelected("Hypixel Motion"));
    }

    @Override
    public void onDisable() {
        this.resetState(false);
    }

    @Override
    public void onWorld(WorldEvent event) {
        this.resetState(mode.isSelected("Hypixel Motion"));
    }

    private void resetState(boolean startMotionDisabler) {
        watchDogDisabled = false;
        stuckOnAir = false;
        airStuckTicks = 0;
        airTicks = 0;
        startDisabler = startMotionDisabler;

        sentFirstOpen = false;
        caughtClientStatus = false;
        caughtCloseWindow = false;

        verusTicks = 0;
    }

    @Override
    public void onPreUpdate(PreUpdateEvent event) {
        if (mode.isSelected("Hypixel Motion")) {
            if (!watchDogDisabled) {
                if (mc.thePlayer.onGround) {
                    airTicks = 0;
                } else {
                    airTicks++;
                }

                if (stuckOnAir && airTicks >= 9) {
                    MovementUtil.stopMovingQuickly();
                }
            }
        }
    }

    @Override
    public void onTick(TickEvent event) {
        if (mc.thePlayer == null) return;

        if (mode.isSelected("Hypixel InvMove")) {
            caughtClientStatus = false;
            caughtCloseWindow = false;

            if (mc.currentScreen instanceof GuiInventory || DewCommon.moduleManager.getModule(InvManager.class).isEnabled() && DewCommon.moduleManager.getModule(InvManager.class).isCleaning()) {
                if (!sentFirstOpen) {
                    PacketUtil.sendPacketAsSilent(new C0DPacketCloseWindow());
                    sentFirstOpen = true;
                }

                int safePacketTick = mc.thePlayer.isPotionActive(Potion.moveSpeed) ? 3 : 4;

                if (mc.thePlayer.ticksExisted % safePacketTick == 0) {
                    PacketUtil.sendPacketAsSilent(new C0DPacketCloseWindow());
                } else if (mc.thePlayer.ticksExisted % safePacketTick == 1) {
                    PacketUtil.sendPacketAsSilent(new C16PacketClientStatus(C16PacketClientStatus.EnumState.OPEN_INVENTORY_ACHIEVEMENT));
                }
            } else {
                sentFirstOpen = false;
            }
        }
    }

    @Override
    public void onPreMotion(PreMotionEvent event) {
        if (mc.thePlayer == null) return;

        if (mode.isSelected("Hypixel Motion")) {
            if (startDisabler && mc.thePlayer.inventory.getStackInSlot(8) != null && mc.thePlayer.inventory.getStackInSlot(8).getItem() == Items.nether_star) {
                LogUtil.printChat("Cancelled watchdog motion disabler");
                watchDogDisabled = false;
                startDisabler = false;
                return;
            }

            if (!watchDogDisabled) {
                if (startDisabler) {
                    if (mc.thePlayer.onGround) {
                        mc.thePlayer.jump();
                        stuckOnAir = true;
                    } else if (airStuckTicks > 1) {
                        startDisabler = false;
                    }
                }

                if (stuckOnAir && airTicks >= 9) {
                    mc.thePlayer.motionY = 0.0;
                    if (airTicks % 2 == 0) {
                        event.z += 0.095;
                    }
                }
            }
        }

        if (mode.isSelected("Hypixel Omni Sprint") && (!mode.isSelected("Hypixel Motion") || watchDogDisabled) && !DewCommon.rotationManager.isRotating() && mc.thePlayer.isSprinting() && MovementUtil.isMoving() && mc.gameSettings.keyBindBack.isKeyDown()) {
            event.yaw = (float) MovementUtil.getDirection();
        }
    }

    @Override
    public void onSendPacket(SendPacketEvent event) {
        if (mc.thePlayer == null) return;

        Packet<?> packet = event.packet;

        if (mode.isSelected("Verus") && (packet instanceof C0FPacketConfirmTransaction || packet instanceof C00PacketKeepAlive)) {
            event.cancel();
        }

        if (mode.isSelected("No Sprint") && packet instanceof C0BPacketEntityAction && (((C0BPacketEntityAction) packet).getAction() == C0BPacketEntityAction.Action.STOP_SPRINTING || ((C0BPacketEntityAction) packet).getAction() == C0BPacketEntityAction.Action.START_SPRINTING)) {
            event.cancel();
        }

        if (mode.isSelected("Hypixel InvMove")) {
            if (packet instanceof C16PacketClientStatus) {
                if (caughtClientStatus) {
                    event.cancel();
                }
                caughtClientStatus = true;
            }

            if (packet instanceof C0DPacketCloseWindow) {
                if (caughtCloseWindow) {
                    event.cancel();
                }
                caughtCloseWindow = true;
            }
        }
    }

    @Override
    public void onReceivedPacket(ReceivedPacketEvent event) {
        if (mc.thePlayer == null) return;

        Packet<?> packet = event.packet;

        if (mode.isSelected("Hypixel Motion")) {
            if (!watchDogDisabled && stuckOnAir && packet instanceof S08PacketPlayerPosLook) {
                mc.thePlayer.rotationYaw = mc.thePlayer.rotationYaw + 10;
                LogUtil.printChat(String.valueOf(airStuckTicks));
                airStuckTicks++;
                if (airStuckTicks > 20) {
                    LogUtil.printChat("Disabled watchdog motion checks");

                    airStuckTicks = 0;
                    airTicks = 0;
                    stuckOnAir = false;

                    watchDogDisabled = true;
                }
            }
        }
    }
}
