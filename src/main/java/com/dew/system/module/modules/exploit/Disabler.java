package com.dew.system.module.modules.exploit;

import com.dew.DewCommon;
import com.dew.system.event.events.*;
import com.dew.system.module.Module;
import com.dew.system.module.ModuleCategory;
import com.dew.system.module.modules.player.Manager;
import com.dew.system.module.modules.player.Scaffold;
import com.dew.system.settingsvalue.MultiSelectionValue;
import com.dew.utils.Clock;
import com.dew.utils.LogUtil;
import com.dew.utils.MovementUtil;
import com.dew.utils.PacketUtil;
import net.minecraft.client.gui.inventory.GuiInventory;
import net.minecraft.init.Blocks;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.network.Packet;
import net.minecraft.network.handshake.client.C00Handshake;
import net.minecraft.network.play.client.*;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;
import net.minecraft.potion.Potion;
import net.minecraft.util.BlockPos;
import net.minecraft.util.EnumFacing;
import org.lwjgl.input.Keyboard;

import java.util.Collections;
import java.util.List;
import java.util.concurrent.CopyOnWriteArrayList;

public class Disabler extends Module {

    private static final MultiSelectionValue mode = new MultiSelectionValue("Mode", Collections.singletonList("No Sprint"), "No Sprint", "Inventory Open", "Hypixel Motion", "Hypixel InvMove", "Hypixel Omni Sprint", "Vulcan Scaffold", "Solo Legends", "Transaction", "Test");
    private boolean watchDogDisabled = false;
    private boolean startDisabler = false;
    private boolean stuckOnAir = false;
    private int airStuckTicks = 0;
    private int airTicks = 0;
    private boolean sentFirstOpen = false;
    private boolean caughtClientStatus = false;
    private boolean caughtCloseWindow = false;

    private int lastKeepAliveKey = 0;
    private int transactionCount = 0;
    private final List<Packet<?>> delayedTransactions = new CopyOnWriteArrayList<>();

    public Disabler() {
        super("Disabler", ModuleCategory.EXPLOIT, Keyboard.KEY_NONE, false, true, true);
    }

    public boolean canLowHop() {
        return this.isEnabled() && mode.isSelected("Hypixel Motion") && !startDisabler && watchDogDisabled;
    }

    public boolean isInventoryDisablerEnabled() {
        return mode.isSelected("Hypixel InvMove");
    }

    @Override
    public void onEnable() {
        this.resetState(mode.isSelected("Hypixel Motion"));

        if (mode.isSelected("Solo Legends")) {
            LogUtil.printChat("Use double jump with bomber kit to disable anticheat");
        }
    }

    @Override
    public void onDisable() {
        this.resetState(false);
    }

    @Override
    public void onLoadWorld(WorldLoadEvent event) {
        this.resetState(mode.isSelected("Hypixel Motion"));
    }

    private void resetState(boolean startMotionDisabler) {
        watchDogDisabled = false;
        stuckOnAir = false;
        airStuckTicks = 0;
        airTicks = 0;
        startDisabler = startMotionDisabler;

        sentFirstOpen = false;
        caughtClientStatus = false;
        caughtCloseWindow = false;

        transactionCount = 0;
        lastKeepAliveKey = 0;
        delayedTransactions.clear();
    }

    @Override
    public void onPreUpdate(PreUpdateEvent event) {
        if (mode.isSelected("Hypixel Motion")) {
            if (!watchDogDisabled) {
                if (mc.thePlayer.onGround) {
                    airTicks = 0;
                } else {
                    airTicks++;
                }

                if (stuckOnAir && airTicks >= 9) {
                    MovementUtil.stopMovingQuickly();
                }
            }
        }

        if (mode.isSelected("Hypixel InvMove")) {
            caughtClientStatus = false;
            caughtCloseWindow = false;

            if (mc.currentScreen instanceof GuiInventory || DewCommon.moduleManager.getModule(Manager.class).isEnabled() && DewCommon.moduleManager.getModule(Manager.class).isCleaning()) {
                if (!sentFirstOpen) {
                    PacketUtil.sendPacketAsSilent(new C0DPacketCloseWindow());
                    sentFirstOpen = true;
                }

                int safePacketTick = mc.thePlayer.isPotionActive(Potion.moveSpeed) ? 3 : 4;

                if (mc.thePlayer.ticksExisted % safePacketTick == 0) {
                    PacketUtil.sendPacketAsSilent(new C0DPacketCloseWindow());
                } else if (mc.thePlayer.ticksExisted % safePacketTick == 1) {
                    PacketUtil.sendPacketAsSilent(new C16PacketClientStatus(C16PacketClientStatus.EnumState.OPEN_INVENTORY_ACHIEVEMENT));
                }
            } else {
                sentFirstOpen = false;
            }
        }
    }

    @Override
    public void onTick(TickEvent event) {
        if (mc.thePlayer == null) return;

        if (mode.isSelected("Transaction")) {
            if (mc.thePlayer.ticksExisted % 120 == 0) {
                if (!delayedTransactions.isEmpty()) {
                    delayedTransactions.forEach(PacketUtil::sendPacketAsSilent);
                    PacketUtil.sendPacketAsSilent(new C00PacketKeepAlive(lastKeepAliveKey));
                    delayedTransactions.clear();
                }
            }
        }
    }

    @Override
    public void onPreMotion(PreMotionEvent event) {
        if (mc.thePlayer == null) return;

        if (mode.isSelected("Vulcan Scaffold") && DewCommon.moduleManager.getModule(Scaffold.class).isEnabled() && mc.thePlayer.ticksExisted % 15 == 0 && !mc.thePlayer.isInWater() && !mc.thePlayer.isDead && !mc.thePlayer.isOnLadder()) {
            PacketUtil.sendPacket(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SPRINTING));
            PacketUtil.sendPacket(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SPRINTING));
            PacketUtil.sendPacket(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SNEAKING));
            PacketUtil.sendPacket(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SNEAKING));
        }

        if (mode.isSelected("Hypixel Motion")) {
            if (startDisabler && mc.thePlayer.inventory.getStackInSlot(8) != null && mc.thePlayer.inventory.getStackInSlot(8).getItem() == Items.nether_star) {
                LogUtil.printChat("Cancelled watchdog motion disabler");
                watchDogDisabled = false;
                startDisabler = false;
                return;
            }

            if (!watchDogDisabled) {
                if (startDisabler) {
                    if (mc.thePlayer.onGround) {
                        mc.thePlayer.jump();
                        stuckOnAir = true;
                    } else if (airStuckTicks > 1) {
                        startDisabler = false;
                    }
                }

                if (stuckOnAir && airTicks >= 9) {
                    mc.thePlayer.motionY = 0.0;
                    if (airTicks % 2 == 0) {
                        event.z += 0.095;
                    }
                }
            }
        }

        if (mode.isSelected("Hypixel Omni Sprint") && (!mode.isSelected("Hypixel Motion") || watchDogDisabled) && !DewCommon.rotationManager.isRotating() && mc.thePlayer.isSprinting() && MovementUtil.isMoving() && mc.gameSettings.keyBindBack.isKeyDown()) {
            event.yaw += 180f;
        }
    }

    @Override
    public void onSendPacket(SendPacketEvent event) {
        if (mc.thePlayer == null) return;

        Packet<?> packet = event.packet;

        if (mode.isSelected("Transaction")) {
            if (packet instanceof C0FPacketConfirmTransaction) {
                C0FPacketConfirmTransaction transactionPacket = (C0FPacketConfirmTransaction) packet;
                if (transactionPacket.getUid() < 0) {
                    transactionCount++;

                    if (transactionCount > 5) {
                        delayedTransactions.add(transactionPacket);
                        event.cancel();
                    }
                }
            }

            if (packet instanceof C00PacketKeepAlive) {
                C00PacketKeepAlive keepAlivePacket = (C00PacketKeepAlive) packet;
                lastKeepAliveKey = keepAlivePacket.getKey();
                event.cancel();
            }
        }

        if (mode.isSelected("Solo Legends") && packet instanceof C13PacketPlayerAbilities) {
            event.cancel();
        }

        if (mode.isSelected("No Sprint") && packet instanceof C0BPacketEntityAction && (((C0BPacketEntityAction) packet).getAction() == C0BPacketEntityAction.Action.STOP_SPRINTING || ((C0BPacketEntityAction) packet).getAction() == C0BPacketEntityAction.Action.START_SPRINTING)) {
            event.cancel();
        }

        if (mode.isSelected("Inventory Open") && packet instanceof C16PacketClientStatus && ((C16PacketClientStatus) packet).getStatus() == C16PacketClientStatus.EnumState.OPEN_INVENTORY_ACHIEVEMENT) {
            event.cancel();
        }

        if (mode.isSelected("Hypixel InvMove")) {
            if (packet instanceof C16PacketClientStatus) {
                if (caughtClientStatus) {
                    event.cancel();
                }
                caughtClientStatus = true;
            }

            if (packet instanceof C0DPacketCloseWindow) {
                if (caughtCloseWindow) {
                    event.cancel();
                }
                caughtCloseWindow = true;
            }
        }

        if (mode.isSelected("Test")) {
            if (packet instanceof C0FPacketConfirmTransaction) {
                if (((C0FPacketConfirmTransaction) packet).getUid() < 0) {
                    if (tick1 >= 2) {
                        LogUtil.printChat("reset1");
                        tick1 = 0;
                    } else {
                        PacketUtil.sendPacketAsSilent(new C0FPacketConfirmTransaction(((C0FPacketConfirmTransaction) packet).getWindowId(), (short) Integer.MIN_VALUE, ((C0FPacketConfirmTransaction) packet).isAccepted()));
                        LogUtil.printChat("1 under than 0 " + ((C0FPacketConfirmTransaction) packet).getUid());
                    }
                    tick1++;
                    event.cancel();
                }

                if (((C0FPacketConfirmTransaction) packet).getUid() > 0) {
                    if (tick2 >= 2) {
                        LogUtil.printChat("reset2");
                        tick2 = 0;
                    } else {
                        PacketUtil.sendPacketAsSilent(new C0FPacketConfirmTransaction(((C0FPacketConfirmTransaction) packet).getWindowId(), (short) Integer.MAX_VALUE, ((C0FPacketConfirmTransaction) packet).isAccepted()));
                        LogUtil.printChat("2 more than 0 " + ((C0FPacketConfirmTransaction) packet).getUid());
                    }
                    tick2++;
                    event.cancel();
                }
            }
        }
    }

    private int tick1 = 0;
    private int tick2 = 0;

    @Override
    public void onReceivedPacket(ReceivedPacketEvent event) {
        if (mc.thePlayer == null) return;

        Packet<?> packet = event.packet;

        if (mode.isSelected("Hypixel Motion")) {
            if (!watchDogDisabled && stuckOnAir && packet instanceof S08PacketPlayerPosLook) {
                mc.thePlayer.rotationYaw = mc.thePlayer.rotationYaw + 10;
                LogUtil.printChat(String.valueOf(airStuckTicks));
                airStuckTicks++;
                if (airStuckTicks > 20) {
                    LogUtil.printChat("Disabled watchdog motion checks");

                    airStuckTicks = 0;
                    airTicks = 0;
                    stuckOnAir = false;

                    watchDogDisabled = true;
                }
            }
        }
    }
}
